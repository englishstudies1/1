<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Studies Portal | Mourad Project</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #1e3a8a;
      --secondary: #7c3aed;
      --bg-gradient: linear-gradient(-45deg, #0f172a, #1e3a8a, #3b82f6, #1e40af);
      --danger: #ef4444;
      --success: #10b981;
    }

    body, html { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; min-height: 100vh; }

    .main-wrapper {
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      min-height: 100vh;
      display: flex; flex-direction: column;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px; text-align: center; color: white;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      display: flex; justify-content: space-between; align-items: center;
    }
    
    header h1 { margin: 0 auto; }
    #logoutBtn { display: none; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 15px; border-radius: 20px; cursor: pointer; }

    #welcomePage {
      display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1;
      text-align: center; color: white;
    }

    .welcome-card {
      background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 20px;
      backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2);
    }

    .welcome-card i.main-logo { font-size: 80px; margin-bottom: 20px; color: #fff; }

    .action-btn {
      padding: 12px 35px; border-radius: 50px; border: none; cursor: pointer;
      font-weight: 600; transition: 0.3s; margin: 10px; text-transform: uppercase;
    }

    .btn-login { background: white; color: var(--primary); }
    .btn-signup { background: var(--primary); color: white; }

    .form-container {
      display: none; max-width: 500px; margin: 30px auto; padding: 25px;
      background: white; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.4);
    }

    input, select { width: 100%; padding: 11px; margin: 7px 0; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; box-sizing: border-box; }
    .phone-row { display: flex; gap: 8px; }
    .phone-row select { width: 135px; }

    #dashboard, #adminDashboard { display: none; max-width: 1100px; margin: 20px auto; padding: 20px; }
    
    .news-ticker {
      background: #fbbf24; color: #000; padding: 12px; border-radius: 12px;
      margin-bottom: 20px; font-weight: 600; display: flex; align-items: center;
    }

    .grid-menu {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;
    }

    .card {
      background: white; padding: 25px; border-radius: 15px; text-align: center;
      transition: 0.3s; cursor: pointer; border-bottom: 4px solid var(--primary);
    }
    .card:hover { transform: translateY(-10px); background: #f0f4ff; }
    .card i { font-size: 2.5rem; color: var(--primary); margin-bottom: 10px; }

    .sub-page { display: none; background: white; padding: 30px; border-radius: 20px; color: #333; }
    
    .module-box { 
        background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; 
        margin: 10px 0; border-radius: 10px; font-weight: 500;
        display: flex; justify-content: space-between; align-items: center;
        transition: 0.2s; cursor: pointer; flex-direction: column; align-items: flex-start;
    }
    .module-box:hover { background: #e2e8f0; }
    .module-box-header { width: 100%; display: flex; justify-content: space-between; }
    .lesson-link { font-size: 0.85rem; color: var(--primary); margin-top: 5px; text-decoration: none; display: block; }
    .lesson-link:hover { text-decoration: underline; }

    .schedule-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .schedule-table th, .schedule-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    .schedule-table th { background: var(--primary); color: white; }
    .schedule-table tr:nth-child(even) { background: #f9fafb; }

    .announcement-item {
        border-left: 5px solid var(--secondary);
        background: #f3f4f6; padding: 15px; margin-bottom: 10px; border-radius: 0 10px 10px 0;
    }
    .announcement-date { font-weight: bold; color: var(--primary); font-size: 0.9rem; }

    .admin-section { background: rgba(255,255,255,0.1); margin-top: 30px; padding: 20px; border-radius: 15px; color: white; }
    .badge-principal { background: #ef4444; padding: 4px 10px; border-radius: 5px; font-weight: bold; margin-right: 5px; }
    .badge-other { background: #4b5563; padding: 4px 10px; border-radius: 5px; margin-left: 5px; font-size: 0.85rem; }

    .link-item {
      display: flex; align-items: center; gap: 10px; padding: 12px;
      background: #f1f5f9; border-radius: 8px; margin-bottom: 10px;
      text-decoration: none; color: #333; font-weight: 600; transition: 0.3s;
    }
    .link-item:hover { background: #e2e8f0; transform: translateX(10px); }
    .link-item i.fa-whatsapp { color: #25d366; }
    .link-item i.fa-google { color: #4285f4; }

    .back-btn { background: #64748b; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }
    .footer-copy { text-align: center; color: rgba(255,255,255,0.6); padding: 20px; font-size: 0.9rem; }
    .hidden { display: none !important; }

    .module-tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .tab-item { flex: 1; padding: 15px; background: var(--primary); color: white; border-radius: 10px; text-align: center; cursor: pointer; font-weight: bold; }
    .alert-info { background: #dbeafe; color: #1e40af; padding: 10px; border-radius: 8px; border-left: 4px solid #1e40af; margin-bottom: 15px; font-size: 0.9rem; }

    /* Admin Panel Styles */
    .admin-container { background: white; padding: 20px; border-radius: 20px; min-height: 80vh; }
    .admin-header-info { background: #d1fae5; color: #065f46; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #6ee7b7; }
    .admin-nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .admin-nav button { padding: 10px 20px; border: none; background: #f3f4f6; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .admin-nav button.active { background: var(--secondary); color: white; }
    .admin-tab { display: none; }
    .admin-tab.active { display: block; }
    
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .data-table th, .data-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    .data-table th { background: #f8fafc; color: #64748b; }
    .btn-delete { background: #fee2e2; color: #ef4444; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    
    .admin-form-box { background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
    .admin-form-box h3 { margin-top: 0; color: var(--primary); }
  </style>
</head>
<body>

<div class="main-wrapper">
  <header>
    <h1><i class="fas fa-graduation-cap"></i> English Studies Portal</h1>
    <button id="logoutBtn" onclick="logout()">Logout</button>
  </header>

  <div id="welcomePage">
    <div class="welcome-card">
      <i class="fas fa-book-reader main-logo"></i>
      <h2>Welcome Student!</h2>
      <div class="btn-group">
        <button class="action-btn btn-login" onclick="showForm('login')">Login</button>
        <button class="action-btn btn-signup" onclick="showForm('signup')">Sign Up</button>
      </div>
    </div>
  </div>

  <div id="authContainer" class="form-container">
    <button class="back-btn" onclick="resetToWelcome()">‚Üê Back</button>
    
    <div id="loginForm" class="hidden">
      <h2>Login</h2>
      <div id="loginError" style="color:red; font-size:0.9rem; display:none; margin-bottom:10px;"></div>
      <input type="email" id="loginEmail" placeholder="Email Address">
      <input type="password" id="loginPass" placeholder="Password">
      <button class="action-btn btn-signup" style="width:100%" onclick="handleLogin()">Enter Portal</button>
    </div>

    <div id="signupForm" class="hidden">
      <h2>Create New Account</h2>
      <div id="signupError" style="color:red; font-size:0.9rem; display:none; margin-bottom:10px;"></div>
      <div style="display:flex; gap:10px">
        <input type="text" id="regFName" placeholder="First Name">
        <input type="text" id="regLName" placeholder="Last Name">
      </div>
      <input type="text" id="regMassar" placeholder="Massar Code (Letter + Digits)">
      <input type="text" id="regApogee" placeholder="Apog√©e Number (Digits)">
      <div class="phone-row">
        <select id="regCountry">
          <option value="+212">üá≤üá¶ MA +212</option>
          <option value="+962">üáØüá¥ JO +962</option>
          <option value="+970">üáµüá∏ PS +970</option>
          <option value="+974">üá∂üá¶ QA +974</option>
          <option value="+971">üá¶üá™ AE +971</option>
        </select>
        <input type="tel" id="regPhone" placeholder="Phone Number">
      </div>
      <input type="email" id="regEmail" placeholder="Email Address (@gmail.com)">
      <input type="password" id="regPass" placeholder="Create Password">
      <select id="groupSelect">
        <option value="">Select Your Group</option>
        <option value="GR1">Group 1 (GR1)</option>
        <option value="GR2">Group 2 (GR2)</option>
      </select>
      <button class="action-btn btn-signup" style="width:100%" onclick="handleSignup()">Register & Enter</button>
    </div>
  </div>

  <div id="dashboard">
    <div class="news-ticker" id="newsTicker">
      <i class="fas fa-bullhorn" style="margin-right:10px;"></i>
      <marquee id="marqueeText">Loading Announcements...</marquee>
    </div>
    
    <div id="mainGrid" class="grid-menu">
      <div class="card" onclick="openSub('modules')"><i class="fas fa-book"></i><h3>Modules</h3></div>
      <div class="card" onclick="openSub('exams')"><i class="fas fa-file-signature"></i><h3>Last Year Exams</h3></div>
      <div class="card" onclick="openSub('timetable')"><i class="fas fa-calendar-alt"></i><h3>Timetable</h3></div>
      <div class="card" onclick="openSub('makeup')"><i class="fas fa-clock"></i><h3>Makeup Sessions</h3></div>
      <div class="card" onclick="openSub('all_ann')"><i class="fas fa-list-ul"></i><h3>Announcements</h3></div>
      <div class="card" onclick="openSub('space')"><i class="fas fa-link"></i><h3>Student Space</h3></div>
    </div>

    <div id="subPage" class="sub-page">
      <button class="back-btn" onclick="closeSub()">‚Üê Back to Menu</button>
      <div id="subContent"></div>
    </div>
    <div class="admin-section" id="adminArea"></div>
  </div>

  <div id="adminDashboard" class="hidden">
    <div class="admin-container">
      <div id="adminHeader" class="admin-header-info"></div>
      
      <div class="admin-nav">
        <button class="active" onclick="switchAdminTab('adm-students', this)">Students</button>
        <button onclick="switchAdminTab('adm-modules', this)">Modules & Lessons</button>
        <button onclick="switchAdminTab('adm-exams', this)">Last Year Exams</button>
        <button onclick="switchAdminTab('adm-timetable', this)">Timetable</button>
        <button onclick="switchAdminTab('adm-updates', this)">Updates & Makeup</button>
      </div>

      <div id="adm-students" class="admin-tab active">
        <div class="admin-form-box">
          <h3>Add New Student Manually</h3>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="text" id="admNewFName" placeholder="First Name">
            <input type="text" id="admNewLName" placeholder="Last Name">
            <input type="email" id="admNewEmail" placeholder="Email (@gmail.com)">
            <input type="password" id="admNewPass" placeholder="Password">
            <select id="admNewGroup">
               <option value="GR1">GR1</option>
               <option value="GR2">GR2</option>
            </select>
          </div>
          <button class="action-btn btn-signup" onclick="adminAddStudent()">Add Student</button>
        </div>
        <h3>Registered Students List</h3>
        <table class="data-table">
          <thead><tr><th>Name</th><th>Email</th><th>Group</th><th>Codes</th><th>Action</th></tr></thead>
          <tbody id="studentTableBody"></tbody>
        </table>
      </div>

      <div id="adm-modules" class="admin-tab">
        <div class="admin-form-box">
          <h3>Add Lesson/Resource (Drive Link)</h3>
          <select id="admModSemester" onchange="updateAdminModuleList()">
            <option value="S1">Semester 1 (S1)</option>
            <option value="S2">Semester 2 (S2)</option>
          </select>
          <select id="admModName">
             </select>
          <select id="admModGroup">
            <option value="GR1">Group 1</option>
            <option value="GR2">Group 2</option>
          </select>
          <input type="text" id="admLessonTitle" placeholder="Lesson Title (e.g. Lecture 1 PDF)">
          <input type="url" id="admLessonLink" placeholder="Google Drive Link">
          <button class="action-btn btn-signup" onclick="addLesson()">Add Material</button>
        </div>
      </div>

      <div id="adm-exams" class="admin-tab">
        <div class="admin-form-box">
           <h3>Add Last Year Exam</h3>
           <select id="admExamSemester" onchange="updateAdminExamList()">
             <option value="S1">Semester 1</option>
             <option value="S2">Semester 2</option>
           </select>
           <select id="admExamModule"></select>
           <select id="admExamGroup">
             <option value="GR1">Group 1</option>
             <option value="GR2">Group 2</option>
           </select>
           <input type="text" id="admExamTitle" placeholder="Exam Title (e.g. 2024 Normal Session)">
           <input type="url" id="admExamLink" placeholder="Link">
           <button class="action-btn btn-signup" onclick="addExam()">Add Exam</button>
        </div>
      </div>

      <div id="adm-timetable" class="admin-tab">
        <div class="alert-info">Edit the table cells directly, then click Save.</div>
        <h3>GR1 Timetable</h3>
        <div contenteditable="true" id="editTableGR1" style="border:1px solid #ccc; padding:10px; margin-bottom:10px; background:#fff;"></div>
        <button class="action-btn btn-signup" onclick="saveTimetable('GR1')">Save GR1 Timetable</button>
        <hr>
        <h3>GR2 Timetable</h3>
        <div contenteditable="true" id="editTableGR2" style="border:1px solid #ccc; padding:10px; margin-bottom:10px; background:#fff;"></div>
        <button class="action-btn btn-signup" onclick="saveTimetable('GR2')">Save GR2 Timetable</button>
      </div>

      <div id="adm-updates" class="admin-tab">
        <div class="admin-form-box">
          <h3>Add Announcement</h3>
          <textarea id="admAnnText" rows="3" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="Announcement text..."></textarea>
          <input type="date" id="admAnnDate">
          <select id="admAnnGroup">
            <option value="GR1">Group 1</option>
            <option value="GR2">Group 2</option>
            <option value="ALL">Both Groups</option>
          </select>
          <button class="action-btn btn-signup" onclick="addAnnouncement()">Post Announcement</button>
        </div>

        <div class="admin-form-box">
          <h3>Add Makeup Session</h3>
          <select id="mkpGroup">
            <option value="GR1">GR1</option>
            <option value="GR2">GR2</option>
          </select>
          <select id="mkpModule">
             <option>Grammar 1</option><option>Spoken English</option><option>Guided Reading 1</option>
             <option>University Work Methodology</option><option>Paragraph Writing</option>
             <option>Reading Comprehension</option><option>Academic Vocabulary</option>
             <option>British American Civilization</option><option>Oral Communication</option>
             <option>Composition</option><option>Digital Culture</option>
             <option>Grammar 2</option><option>Reading Comprehension 2</option><option>Guided Reading 2</option>
          </select>
          <input type="date" id="mkpDate">
          <div style="display:flex; gap:10px;">
            <select id="mkpLocType">
              <option value="Room">Room</option>
              <option value="Amphi">Amphi</option>
            </select>
            <input type="number" id="mkpLocNum" placeholder="Number (1-32 or 1-3)">
          </div>
          <button class="action-btn btn-signup" onclick="addMakeup()">Add Session</button>
        </div>
      </div>

    </div>
  </div>

  <div class="footer-copy">Mourad Project's @ 2026</div>
</div>

<script>
  /* ---------------- CONFIGURATION & DB INIT ---------------- */
  // Admins List
  const adminsDB = [
    { name: "Mourad", email: "skyline.mourad@gmail.com", pass: "Mourad@2003m", role: "admin" },
    { name: "Hajar", email: "hajaryahya40@gmail.com", pass: "Hajar@yahya12n", role: "admin" },
    { name: "Moneim", email: "mounaimegaoui88@gmail.com", pass: "Moneim@2005r", role: "admin" },
    { name: "Samia", email: "samsamaboulkassim@gmail.com", pass: "Samia@2004f", role: "admin" },
    { name: "Mohamed", email: "simoach2003@gmail.com", pass: "simo@1999s", role: "admin" }
  ];

  // Module Lists
  const modulesS1 = ["Grammar 1", "Spoken English", "Guided Reading 1", "University Work Methodology", "Paragraph Writing", "Reading Comprehension", "Academic Vocabulary"];
  const modulesS2 = ["British American Civilization", "Oral Communication", "Composition", "Digital Culture", "Grammar 2", "Reading Comprehension 2", "Guided Reading 2"];

  // Default Timetable HTML (Base structure)
  const defaultTimetableHTML = `
    <table class="schedule-table">
      <tr><th>Day</th><th>Module</th><th>Time</th></tr>
      <tr><td>Monday</td><td>(Empty)</td><td>--:--</td></tr>
      <tr><td>Tuesday</td><td>(Empty)</td><td>--:--</td></tr>
      <tr><td>Wednesday</td><td>(Empty)</td><td>--:--</td></tr>
      <tr><td>Thursday</td><td>(Empty)</td><td>--:--</td></tr>
      <tr><td>Friday</td><td>(Empty)</td><td>--:--</td></tr>
    </table>`;

  // Application State
  let currentUser = null;
  let DB = {
    users: [],
    lessons: [], // { id, semester, module, group, title, link }
    exams: [],   // { id, semester, module, group, title, link }
    announcements: [], // { text, date, group }
    makeup: [], // { group, module, date, location }
    timetables: { GR1: defaultTimetableHTML, GR2: defaultTimetableHTML }
  };

  /* ---------------- INITIALIZATION ---------------- */
  window.onload = function() {
    loadDB();
    // Pre-populate admin lists
    updateAdminModuleList(); 
    updateAdminExamList();
  };

  function loadDB() {
    const data = localStorage.getItem('engPortalData_v2');
    if(data) {
      DB = JSON.parse(data);
    } else {
      // Seed initial data if empty
      DB.users = []; 
      saveDB();
    }
  }

  function saveDB() {
    localStorage.setItem('engPortalData_v2', JSON.stringify(DB));
  }

  /* ---------------- AUTHENTICATION LOGIC ---------------- */
  function showForm(type) {
    document.getElementById('welcomePage').style.display = 'none';
    document.getElementById('authContainer').style.display = 'block';
    if(type === 'login') {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('signupForm').classList.add('hidden');
    } else {
      document.getElementById('signupForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
    }
  }

  function resetToWelcome() { location.reload(); }

  function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value.trim();
    const err = document.getElementById('loginError');
    err.style.display = 'none';

    // 1. Check if Admin
    const admin = adminsDB.find(a => a.email === email && a.pass === pass);
    if(admin) {
      loginSuccess(admin);
      return;
    }

    // 2. Check Students
    const student = DB.users.find(u => u.email === email && u.pass === pass);
    if(student) {
      loginSuccess(student);
      return;
    }

    // 3. Fail
    err.innerText = "Invalid Credentials. Please check your email and password.";
    err.style.display = 'block';
  }

  function handleSignup() {
    const fname = document.getElementById('regFName').value.trim();
    const lname = document.getElementById('regLName').value.trim();
    const massar = document.getElementById('regMassar').value.trim();
    const apogee = document.getElementById('regApogee').value.trim();
    const phone = document.getElementById('regPhone').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass').value.trim();
    const group = document.getElementById('groupSelect').value;
    const country = document.getElementById('regCountry').value;

    const err = document.getElementById('signupError');
    err.style.display = 'none';

    // Validation
    if(!fname || !lname || !massar || !apogee || !phone || !email || !pass || !group) {
        err.innerText = "All fields are required."; err.style.display='block'; return;
    }
    
    // Email Check
    if(!email.endsWith('@gmail.com')) {
        err.innerText = "Email must be a @gmail.com address."; err.style.display='block'; return;
    }
    // Massar Check (Letter + Digits, e.g., R130123...)
    if(!/^[A-Za-z]\d+$/.test(massar)) {
        err.innerText = "Invalid Massar Code (Must be Letter + Digits)."; err.style.display='block'; return;
    }
    // Apogee Check (Digits only)
    if(!/^\d+$/.test(apogee)) {
        err.innerText = "Invalid Apogee Code (Digits only)."; err.style.display='block'; return;
    }
    // Duplicate Check
    if(DB.users.find(u => u.email === email)) {
        err.innerText = "Email already registered."; err.style.display='block'; return;
    }

    // Create User
    const newUser = {
        fname, lname, massar, apogee, 
        fullPhone: country + phone, 
        email, pass, group, role: "student"
    };

    DB.users.push(newUser);
    saveDB();
    loginSuccess(newUser);
  }

  function loginSuccess(user) {
    currentUser = user;
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'block';
    
    if(user.role === 'admin') {
      renderAdminDashboard();
    } else {
      renderStudentDashboard();
    }
  }

  function logout() { location.reload(); }

  /* ---------------- STUDENT DASHBOARD LOGIC ---------------- */
  const linksDB = {
    GR1: {
      l1: "https://chat.whatsapp.com/KC8H6nooswS9j3Gg9yozZt",
      l2: "https://chat.whatsapp.com/DGysm3YhQnpE7nGQLDd5km",
      l3: "https://classroom.google.com/c/ODM0OTEzMjY5NTEz?cjc=amozilem"
    },
    GR2: {
      l1: "https://chat.whatsapp.com/D8EFIBAoCqh9MatabkO1oN",
      l2: "https://chat.whatsapp.com/EKZ56fLFPevJ4NvoSkDMV6",
      l3: "https://classroom.google.com/c/NzkyNjU3NjkxNTM0?cjc=ldqb36iw"
    }
  };

  function renderStudentDashboard() {
    document.getElementById('dashboard').style.display = 'block';
    
    // Update Announcements Ticker
    const relevantNews = DB.announcements.filter(a => a.group === currentUser.group || a.group === 'ALL');
    const ticker = document.getElementById('marqueeText');
    if(relevantNews.length > 0) {
      ticker.innerHTML = relevantNews.map(n => `üì¢ ${n.date}: ${n.text}`).join(' | ');
    } else {
      ticker.innerHTML = "üì¢ Welcome, English Studies students, to website. I hope you find everything you need here. If you have any feedback send it.";
    }

    // Admin Info
    const adminArea = document.getElementById('adminArea');
    if(currentUser.group === "GR1") {
      adminArea.innerHTML = `<h4>GR1 Management</h4><p>Admin Principal: <span class="badge-principal">Mourad</span></p><p>Others Admins: <span class="badge-other">Moneim</span><span class="badge-other">Soufiane</span><span class="badge-other">Mohamed</span><span class="badge-other">Samia</span></p>`;
    } else {
      adminArea.innerHTML = `<h4>GR2 Management</h4><p>Admin Principal: <span class="badge-principal">Mourad</span> <span class="badge-principal">Hajar</span></p><p>Others Admins: <span class="badge-other">Marwa</span></p>`;
    }
  }

  function openSub(type) {
    document.getElementById('mainGrid').classList.add('hidden');
    const content = document.getElementById('subContent');
    document.getElementById('subPage').style.display = 'block';
    const gr = currentUser.group;

    if(type === 'space') {
      const data = linksDB[gr];
      content.innerHTML = `<h2>Student Space</h2>
        <a href="${data.l1}" target="_blank" class="link-item"><i class="fab fa-whatsapp"></i> English Studies ${gr}, S1/2</a>
        <a href="${data.l2}" target="_blank" class="link-item"><i class="fab fa-whatsapp"></i> English Studies Announcements S1/2</a>
        <a href="${data.l3}" target="_blank" class="link-item"><i class="fab fa-google"></i> English Studies ${gr}, S1/2</a>
        <hr>
        <a href="https://ent.univh2c.ma/uPortal/normal/render.uP" target="_blank" class="link-item">ENT</a>
        <a href="http://flshm.univh2c.ma/convocation/" target="_blank" class="link-item">Flhsm Convocations</a>`;
    } 
    else if(type === 'modules') {
      content.innerHTML = `<h2>Modules</h2>
      <div class="module-tabs">
        <div class="tab-item" onclick="showFolder('S1', 'mod')">Modules S1</div>
        <div class="tab-item" onclick="showFolder('S2', 'mod')">Modules S2</div>
      </div>
      <div id="folderView"></div>`;
    } 
    else if(type === 'exams') {
      content.innerHTML = `<h2>Last Year Exams</h2>
      <div class="module-tabs">
        <div class="tab-item" onclick="showFolder('S1', 'exam')">Exams S1</div>
        <div class="tab-item" onclick="showFolder('S2', 'exam')">Exams S2</div>
      </div>
      <div id="folderView"></div>`;
    }
    else if(type === 'timetable') {
       content.innerHTML = `<h2>${gr} Timetable</h2>` + DB.timetables[gr];
    }
    else if(type === 'makeup') {
      const myMakeup = DB.makeup.filter(m => m.group === gr);
      let html = `<h2>Makeup Sessions (${gr})</h2>`;
      if(myMakeup.length === 0) html += "<p>No makeup sessions scheduled.</p>";
      myMakeup.forEach(m => {
        html += `<div class="announcement-item">
          <span class="announcement-date">${m.date}</span><br>
          <strong>${m.module}</strong> - ${m.locType} ${m.locNum}
        </div>`;
      });
      content.innerHTML = html;
    }
    else if(type === 'all_ann') {
      const myAnn = DB.announcements.filter(a => a.group === gr || a.group === 'ALL');
      let html = `<h2>All Announcements</h2>`;
      if(myAnn.length === 0) html += "<p>No announcements found.</p>";
      myAnn.forEach(a => {
        html += `<div class="announcement-item"><span class="announcement-date">${a.date}</span><br>${a.text}</div>`;
      });
      content.innerHTML = html;
    }
  }

  function showFolder(semester, mode) {
    const box = document.getElementById('folderView');
    const gr = currentUser.group;
    let list = semester === 'S1' ? modulesS1 : modulesS2;
    
    let html = `<h3>${semester} Content (${gr})</h3>`;
    
    list.forEach(modName => {
        html += `<div class="module-box">
           <div class="module-box-header"><span>${modName}</span> <i class="fas fa-chevron-down"></i></div>`;
        
        // Find items in DB
        let items = [];
        if(mode === 'mod') {
            items = DB.lessons.filter(l => l.group === gr && l.semester === semester && l.module === modName);
        } else {
            items = DB.exams.filter(e => e.group === gr && e.semester === semester && e.module === modName);
        }

        if(items.length > 0) {
            html += `<div style="margin-top:10px; width:100%; border-top:1px solid #eee; padding-top:5px;">`;
            items.forEach(item => {
                html += `<a href="${item.link}" target="_blank" class="lesson-link"><i class="fas fa-link"></i> ${item.title}</a>`;
            });
            html += `</div>`;
        } else {
            html += `<div style="font-size:0.8rem; color:#888; margin-top:5px;">No files available yet.</div>`;
        }
        
        html += `</div>`;
    });
    box.innerHTML = html;
  }

  function closeSub() { document.getElementById('mainGrid').classList.remove('hidden'); document.getElementById('subPage').style.display = 'none'; }


  /* ---------------- ADMIN DASHBOARD LOGIC ---------------- */
  function renderAdminDashboard() {
    document.getElementById('adminDashboard').classList.remove('hidden');
    document.getElementById('adminHeader').innerHTML = `
      <h3>Welcome ${currentUser.name}</h3>
      <p>Email: ${currentUser.email}</p>
    `;
    renderStudentTable();
    // Load existing timetables into editors
    document.getElementById('editTableGR1').innerHTML = DB.timetables.GR1;
    document.getElementById('editTableGR2').innerHTML = DB.timetables.GR2;
  }

  function switchAdminTab(tabId, btn) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
  }

  // --- Student Management ---
  function renderStudentTable() {
    const tbody = document.getElementById('studentTableBody');
    tbody.innerHTML = '';
    DB.users.forEach((u, index) => {
        if(u.role === 'admin') return; // Don't show admins in delete list
        tbody.innerHTML += `
        <tr>
            <td>${u.fname} ${u.lname}</td>
            <td>${u.email}</td>
            <td><span class="badge-principal">${u.group}</span></td>
            <td>M: ${u.massar} / A: ${u.apogee}</td>
            <td><button class="btn-delete" onclick="deleteUser(${index})">Delete</button></td>
        </tr>`;
    });
  }

  function deleteUser(index) {
    if(confirm('Are you sure you want to remove this student?')) {
        DB.users.splice(index, 1);
        saveDB();
        renderStudentTable();
    }
  }

  function adminAddStudent() {
      const f = document.getElementById('admNewFName').value;
      const l = document.getElementById('admNewLName').value;
      const e = document.getElementById('admNewEmail').value;
      const p = document.getElementById('admNewPass').value;
      const g = document.getElementById('admNewGroup').value;

      if(!f || !l || !e || !p) { alert('Fill all fields'); return; }
      if(!e.endsWith('@gmail.com')) { alert('Email must be @gmail.com'); return; }

      DB.users.push({
          fname: f, lname: l, email: e, pass: p, group: g,
          massar: "Manual", apogee: "Manual", phone: "-", role: "student"
      });
      saveDB();
      renderStudentTable();
      alert('Student Added Successfully');
      // Clear inputs
      document.getElementById('admNewFName').value = '';
      document.getElementById('admNewLName').value = '';
      document.getElementById('admNewEmail').value = '';
      document.getElementById('admNewPass').value = '';
  }

  // --- Modules Management ---
  function updateAdminModuleList() {
      const sem = document.getElementById('admModSemester').value;
      const list = sem === 'S1' ? modulesS1 : modulesS2;
      const sel = document.getElementById('admModName');
      sel.innerHTML = '';
      list.forEach(m => sel.innerHTML += `<option>${m}</option>`);
  }

  function addLesson() {
      const sem = document.getElementById('admModSemester').value;
      const mod = document.getElementById('admModName').value;
      const gr = document.getElementById('admModGroup').value;
      const title = document.getElementById('admLessonTitle').value;
      const link = document.getElementById('admLessonLink').value;

      if(!title || !link) { alert('Please enter title and link'); return; }

      DB.lessons.push({ semester: sem, module: mod, group: gr, title: title, link: link });
      saveDB();
      alert(`Lesson added to ${gr} / ${mod}`);
      document.getElementById('admLessonTitle').value = '';
      document.getElementById('admLessonLink').value = '';
  }

  // --- Exams Management ---
  function updateAdminExamList() {
      const sem = document.getElementById('admExamSemester').value;
      const list = sem === 'S1' ? modulesS1 : modulesS2;
      const sel = document.getElementById('admExamModule');
      sel.innerHTML = '';
      list.forEach(m => sel.innerHTML += `<option>${m}</option>`);
  }

  function addExam() {
      const sem = document.getElementById('admExamSemester').value;
      const mod = document.getElementById('admExamModule').value;
      const gr = document.getElementById('admExamGroup').value;
      const title = document.getElementById('admExamTitle').value;
      const link = document.getElementById('admExamLink').value;

      if(!title || !link) { alert('Please enter title and link'); return; }

      DB.exams.push({ semester: sem, module: mod, group: gr, title: title, link: link });
      saveDB();
      alert(`Exam added to ${gr} / ${mod}`);
  }

  // --- Timetable Management ---
  function saveTimetable(group) {
      const content = document.getElementById('editTable' + group).innerHTML;
      DB.timetables[group] = content;
      saveDB();
      alert(group + ' Timetable Updated!');
  }

  // --- Updates Management ---
  function addAnnouncement() {
      const text = document.getElementById('admAnnText').value;
      const date = document.getElementById('admAnnDate').value;
      const gr = document.getElementById('admAnnGroup').value;

      if(!text || !date) { alert('Fill info'); return; }
      
      DB.announcements.unshift({ text, date, group: gr }); // Add to top
      saveDB();
      alert('Announcement Posted');
      document.getElementById('admAnnText').value = '';
  }

  function addMakeup() {
      const gr = document.getElementById('mkpGroup').value;
      const mod = document.getElementById('mkpModule').value;
      const date = document.getElementById('mkpDate').value;
      const type = document.getElementById('mkpLocType').value;
      const num = document.getElementById('mkpLocNum').value;

      if(!date || !num) { alert('Missing Info'); return; }
      
      // Validate Room/Amphi ranges
      const n = parseInt(num);
      if(type === 'Room' && (n < 1 || n > 32)) { alert('Room must be 1-32'); return; }
      if(type === 'Amphi' && (n < 1 || n > 3)) { alert('Amphi must be 1-3'); return; }

      DB.makeup.push({ group: gr, module: mod, date: date, locType: type, locNum: num });
      saveDB();
      alert('Makeup Session Added');
  }

</script>


</body></html>
